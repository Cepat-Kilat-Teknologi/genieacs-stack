# Docker Compose for Production Deployment
# Uses pre-built image from Docker Hub: cepatkilatteknologi/genieacs:latest
#
# Usage:
#   1. Copy .env.example to .env and configure
#   2. Run: docker compose -f docker-compose.prod.yml up -d
#
# For NBI API authentication (X-API-Key):
#   1. Set GENIEACS_NBI_API_KEY in .env
#   2. Run: docker compose -f docker-compose.prod.yml --profile nbi-auth up -d
#   3. Use port 7558 with X-API-Key header for authenticated access
#
# Requirements:
#   - Docker Engine 20.10+
#   - Docker Compose v2+

services:
  ### MongoDB Database ###
  mongo:
    image: mongo:8.0
    container_name: genieacs-mongo
    restart: always
    environment:
      MONGO_DATA_DIR: /data/db
      MONGO_LOG_DIR: /var/log/mongodb
    volumes:
      - mongo_data:/data/db
      - mongo_configdb:/data/configdb
    networks:
      - genieacs_internal
    # MongoDB not exposed to host - only accessible within Docker network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  ### GenieACS Application ###
  genieacs:
    image: cepatkilatteknologi/genieacs:latest
    container_name: genieacs
    restart: always
    depends_on:
      mongo:
        condition: service_healthy
    environment:
      # Security settings - REQUIRED
      GENIEACS_UI_JWT_SECRET: ${GENIEACS_UI_JWT_SECRET:?JWT secret is required}
      GENIEACS_NBI_AUTH: ${GENIEACS_NBI_AUTH:-false}
      GENIEACS_UI_AUTH: ${GENIEACS_UI_AUTH:-true}

      # MongoDB connection
      GENIEACS_MONGODB_CONNECTION_URL: mongodb://mongo:27017/genieacs

      # Log files
      GENIEACS_CWMP_ACCESS_LOG_FILE: /var/log/genieacs/cwmp-access.log
      GENIEACS_NBI_ACCESS_LOG_FILE: /var/log/genieacs/nbi-access.log
      GENIEACS_FS_ACCESS_LOG_FILE: /var/log/genieacs/fs-access.log
      GENIEACS_UI_ACCESS_LOG_FILE: /var/log/genieacs/ui-access.log
      GENIEACS_DEBUG_FILE: /var/log/genieacs/debug.yaml

      # Extensions directory
      GENIEACS_EXT_DIR: /opt/genieacs/ext

      # Production mode
      NODE_ENV: production
    ports:
      # CWMP (TR-069) - CPE devices connect here
      - "${GENIEACS_CWMP_PORT:-7547}:7547"
      # NBI API - Consider binding to 127.0.0.1 if behind reverse proxy
      - "${GENIEACS_NBI_PORT:-7557}:7557"
      # File Server
      - "${GENIEACS_FS_PORT:-7567}:7567"
      # Web UI
      - "${GENIEACS_UI_PORT:-3000}:3000"
    volumes:
      - genieacs_data:/opt/genieacs
      - genieacs_logs:/var/log/genieacs
      - genieacs_ext:/opt/genieacs/ext
    networks:
      - genieacs_internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  ### NBI API Proxy with X-API-Key Authentication ###
  # Enable with: docker compose -f docker-compose.prod.yml --profile nbi-auth up -d
  nbi-proxy:
    profiles:
      - nbi-auth
    image: nginx:alpine
    container_name: genieacs-nbi-proxy
    restart: always
    depends_on:
      genieacs:
        condition: service_healthy
    environment:
      GENIEACS_NBI_API_KEY: ${GENIEACS_NBI_API_KEY:?NBI API Key is required when using nbi-auth profile}
    volumes:
      - ./config/nginx/nbi-proxy.conf.template:/etc/nginx/nbi-proxy.conf.template:ro
      - ./config/nginx/docker-entrypoint.sh:/docker-entrypoint.sh:ro
    entrypoint: ["/docker-entrypoint.sh"]
    ports:
      - "${GENIEACS_NBI_AUTH_PORT:-7558}:7558"
    networks:
      - genieacs_internal
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7558/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 32M
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  mongo_data:
    name: genieacs-prod-mongo-data
  mongo_configdb:
    name: genieacs-prod-mongo-configdb
  genieacs_data:
    name: genieacs-prod-app-data
  genieacs_logs:
    name: genieacs-prod-logs
  genieacs_ext:
    name: genieacs-prod-ext

networks:
  genieacs_internal:
    name: genieacs-prod-network
    driver: bridge