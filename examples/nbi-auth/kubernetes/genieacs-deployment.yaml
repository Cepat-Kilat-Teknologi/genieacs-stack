apiVersion: apps/v1
kind: Deployment
metadata:
  name: genieacs
  namespace: genieacs
  labels:
    app.kubernetes.io/name: genieacs
    app.kubernetes.io/component: app
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: genieacs
  template:
    metadata:
      labels:
        app.kubernetes.io/name: genieacs
        app.kubernetes.io/component: app
    spec:
      imagePullSecrets:
        - name: dockerhub-secret
      nodeSelector:
        longhorn.io/storage: "enabled"
      initContainers:
        # Fix permissions for log and ext directories
        - name: fix-permissions
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              chmod -R 777 /var/log/genieacs
              chmod -R 777 /opt/genieacs/ext
              echo "Permissions fixed!"
          volumeMounts:
            - name: genieacs-logs
              mountPath: /var/log/genieacs
            - name: genieacs-ext
              mountPath: /opt/genieacs/ext
        # Wait for MongoDB to be ready
        - name: wait-for-mongodb
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              until nc -z mongodb 27017; do
                echo "Waiting for MongoDB..."
                sleep 2
              done
              echo "MongoDB is ready!"
      containers:
        # Nginx sidecar for NBI API Key Auth
        - name: nginx-nbi-auth
          image: nginx:1.27-alpine
          ports:
            - containerPort: 7558
              name: nbi-auth
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
          resources:
            requests:
              cpu: "50m"
              memory: "32Mi"
            limits:
              cpu: "200m"
              memory: "64Mi"
        - name: genieacs
          image: cepatkilatteknologi/genieacs:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 7547
              name: cwmp
            - containerPort: 7557
              name: nbi
            - containerPort: 7567
              name: fs
            - containerPort: 3000
              name: ui
          envFrom:
            - configMapRef:
                name: genieacs-config
            - secretRef:
                name: genieacs-secret
          volumeMounts:
            # Only mount logs and ext directories - DO NOT mount /opt/genieacs
            # as it will overwrite the installed GenieACS files from the image
            - name: genieacs-logs
              mountPath: /var/log/genieacs
            - name: genieacs-ext
              mountPath: /opt/genieacs/ext
          resources:
            requests:
              cpu: "250m"
              memory: "256Mi"
            limits:
              cpu: "2000m"
              memory: "1Gi"
          livenessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 90
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          securityContext:
            allowPrivilegeEscalation: false
      volumes:
        - name: genieacs-logs
          persistentVolumeClaim:
            claimName: genieacs-logs
        - name: genieacs-ext
          persistentVolumeClaim:
            claimName: genieacs-ext
        - name: nginx-config
          configMap:
            name: nginx-nbi-config