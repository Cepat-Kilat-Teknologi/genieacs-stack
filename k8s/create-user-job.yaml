# Kubernetes Job to create GenieACS admin user
#
# Usage:
#   1. Edit the ADMIN_PASSWORD value below
#   2. Apply: kubectl apply -f create-user-job.yaml
#   3. Check logs: kubectl logs -n genieacs job/create-genieacs-user
#   4. Delete job: kubectl delete -f create-user-job.yaml
#
apiVersion: batch/v1
kind: Job
metadata:
  name: create-genieacs-user
  namespace: genieacs
  labels:
    app.kubernetes.io/name: genieacs
    app.kubernetes.io/component: setup
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: create-user
          image: mongo:8.0
          env:
            - name: ADMIN_USERNAME
              value: "admin"
            # IMPORTANT: Change this password!
            - name: ADMIN_PASSWORD
              value: "CHANGE_THIS_PASSWORD"
            - name: ADMIN_ROLE
              value: "admin"
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "Creating GenieACS admin user..."

              # Generate salt and hash password
              SALT=$(openssl rand -hex 16)
              HASH=$(echo -n "${ADMIN_PASSWORD}${SALT}" | openssl dgst -sha256 -hex | awk '{print $2}')

              # Connect to MongoDB and create user
              mongosh mongodb://mongodb:27017/genieacs --eval "
                db.users.updateOne(
                  { _id: '${ADMIN_USERNAME}' },
                  {
                    \$set: {
                      _id: '${ADMIN_USERNAME}',
                      password: '${HASH}',
                      salt: '${SALT}',
                      roles: '${ADMIN_ROLE}'
                    }
                  },
                  { upsert: true }
                );
                print('User created/updated successfully!');
                print('Username: ${ADMIN_USERNAME}');
                print('Role: ${ADMIN_ROLE}');
              "

              echo "Done!"